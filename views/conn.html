<% include header.html %>

<div id="leftSide" class="left-split fleft">

    <div id="viewMenu">
        <ul class="menu horizontal x3">
            <li class="blue lightblue" id="pickNav">Nav</li>
            <li class="blue" id="pickWarp">Warp</li>
            <li class="blue" id="pickHelm">Helm</li>
        </ul>
    </div>

    <div class="clear"></div>

    <div id="navMenu" class="nav-menu">
        <ul class="menu x1">
            <li class="green system-select" id="Sector 2298">
                Sector 2298
            </li>
            <li class="green system-select" id="DG Tau">
                DG Tau System
            </li>
            <li class="blue" id="mainViewer">Main Viewer</li>
        </ul>
    </div>

    <div id="helmMenu" class="nav-helm-menu">
        <p>System Orientation</p>
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 width="250px" height="250px" viewBox="-10 0 250 250" xml:space="preserve" class="blue comm-helm-arrow" id="conn-helm-svg">
            <g>
                    <circle fill="none" stroke="#60DDF7" stroke-width="10" stroke-miterlimit="10" stroke-dasharray="1.0174,40.6977" cx="119.5" cy="119.5" r="119.5"/>
            </g>
            <g>
                    <circle fill="none" stroke="#60DDF7" stroke-width="3" stroke-miterlimit="10" stroke-dasharray="0.9932,19.8643" cx="119.5" cy="119.5" r="119.5"/>
            </g>
            <polygon points="119.500,19.287 157.441,106.500 195.382,193.714 119.500,140.501 43.619,193.714 81.560,106.500" id="conn-helm-pointer" fill="#0F8AA6"/>

        </svg>
        <p>Rotational Thrusters</p>
        <ul class="menu small x2">
            <li class="left green" id="turnLeft">
                <svg class="conn-arrow left">
                    <path d="M20 0 L 20 15 L 0 7.5 Q" fill = "black"/>
                </svg>
            </li>
            <li class="right green" id="turnRight">
                <svg class="conn-arrow right">
                    <path d="M0 0 L 20 7.5 L 0 15 Q" fill = "black"/>
                </svg>
            </li>
        </ul>
        <p>Thruster Control</p>
        <ul class="menu small x1">
            <li class="left green" id="thrustUp">
                <svg class="conn-arrow up">
                    <path d="M0 15 L 10 0 L 20 15 Q" fill = "black"/>
                </svg>
            </li>
            <li class="right green" id="thrustDown">
                <svg class="conn-arrow down">
                    <path d="M0 0 L 10 15 L 20 0 Q" fill = "black"/>
                </svg>
            </li>
        </ul>
    </div>

    <div id="warpMenu" class="nav-helm-menu">
        <div>
            <ul class="menu x1">
                <li class="blue selector" id="setCourse">Set <span class="hotkey">C</span>ourse</li>
            </ul>
            <div class="clear"></div>
            <ul class="menu horizontal small x2">
                <li class="blue selector" id="setWarp"><span class="hotkey">W</span>arp</li>
                <li class="blue selector" id="setImpulse"><span class="hotkey">I</span>mpulse</li>
            </ul>
            <div class="clear"></div>
        </div>
        <div>
            <p id="inputBox">
            </p>
        </div>
        <div>
            <ul class="menu x3">
                <li class="lightgreen numPad"><span class="hotkey">1</span></li>
                <li class="lightgreen numPad"><span class="hotkey">2</span></li>
                <li class="lightgreen numPad"><span class="hotkey">3</span></li>
                <li class="lightgreen numPad"><span class="hotkey">4</span></li>
                <li class="lightgreen numPad"><span class="hotkey">5</span></li>
                <li class="lightgreen numPad"><span class="hotkey">6</span></li>
                <li class="lightgreen numPad"><span class="hotkey">7</span></li>
                <li class="lightgreen numPad"><span class="hotkey">8</span></li>
                <li class="lightgreen numPad"><span class="hotkey">9</span></li>
                <li class="lightgreen numPad"><span class="hotkey">m</span></li>
                <li class="lightgreen numPad"><span class="hotkey">0</span></li>
                <li class="lightgreen numPad"><span class="hotkey">.</span></li>
            </ul>
        </div>
        <div class="clear">
        </div>
        <div>
            <ul class="menu x1">
                <li class="blue" id="engage">
                    <span class="hotkey">E</span>ngage
                </li>
            </ul>
        </div>
    </div>

</div>

<div id="rightSide" class="right-split fleft">
    <iframe id="viewScreen"></iframe>
</div>

<script type="text/javascript">

var selected_option;
var currentSystem = "<%= currentSystem %>";

var $inputbox = $( "#inputBox" );
var $systemSelections = $( ".system-select" );
var $viewScreen = $( "#viewScreen" );

var $pickWarp = $( "#pickWarp" );
var $pickNav = $( "#pickNav" );
var $pickHelm = $( "#pickHelm" );
var $picks = $( "#viewMenu li" );

var $helmMenu = $( "#helmMenu" );
var $navMenu = $( "#navMenu" );
var $warpMenu = $( "#warpMenu" );

var $turnLeft = $( "#turnLeft" );
var $turnRight = $( "#turnRight" );
var $thrustUp = $( "#thrustUp" );
var $thrustDown = $( "#thrustDown" );

var turningLeft = false;
var turningRight = false;
var turnRate = 0;
var turnState = 0;

var navArrow = document.getElementById( "conn-helm-pointer" );

var MENU_STATES = { NAV : "Navigation", HELM : "Helm", WARP : "Warp" };
var menuState = "";

$viewScreen.attr( 'src', 'conn_screen' );


$systemSelections.click( function ( e ) {

    $systemSelections.removeClass( "lightgreen" );
    $(this).addClass( "lightgreen" );

    $viewScreen.attr( "src", "conn_screen?system=" + this.id );

} );


$pickNav.click( function ( e ) {

    $picks.removeClass( "lightblue" );
    $pickNav.addClass( "lightblue" );
    $helmMenu.hide();
    $warpMenu.hide();
    $navMenu.show();
    menuState = MENU_STATES.NAV;

} );


$pickHelm.click( function ( e ) {

    $picks.removeClass( "lightblue" );
    $pickHelm.addClass( "lightblue" );
    $helmMenu.show();
    $navMenu.hide();
    $warpMenu.hide();
    menuState = MENU_STATES.HELM;

    $viewScreen.attr( "src", "tactical_screen?zoom=phasers&zoom_level=10" );

} );


$pickWarp.click( function ( e ) {

    $picks.removeClass( "lightblue" );
    $pickWarp.addClass( "lightblue" );
    $helmMenu.hide();
    $navMenu.hide();
    $warpMenu.show();
    menuState = MENU_STATES.WARP;

    $viewScreen.attr( "src", "conn_screen?system=" + currentSystem );

} );


$( ".selector" ).click( function () {

    setWarpMenuFunction( this.id );

} );


function setWarpMenuFunction ( selection ) {

    selected_option = selection;
    $( ".selector" ).removeClass( "lightblue" );
    $( "#" + selection ).addClass( "lightblue" );
    $inputbox.html( "" );

}


$( "#mainViewer" ).click( function () {

    var x = document.getElementById( "viewScreen" );
    var searchTerms = x.contentWindow.location.search.replace( "?", "" );

    trek.api(
        "command/main-viewer",
        { screen : "conn_screen?" + searchTerms },
        'POST',
        updateNavigationData );

} );


function addCharToInput ( new_char ) {

    var now = $inputbox.html();
    $inputbox.html( now + new_char );

}


$( ".numPad" ).click( function () {

    var x_char = $( this ).html();
    addCharToInput( x_char );

} );


function engage () {

    var e = $inputbox.html().split( "m" );

    switch( selected_option ) {

        case "setCourse":

            trek.api(
                'navigation/course',
                { bearing : e[0], mark : e[1] },
                'PUT',
                function () { console.log( "Setcourse confirmed" ); }
            );

            break;

        case "setWarp":

            trek.api(
                "navigation/warp",
                { speed : e[0] },
                'PUT',
                function ( data ) { console.log( data ) } );


            break;

        case "setImpulse":

            trek.api(
                "navigation/impulse",
                { speed: e[ 0 ] },
                'PUT',
                function ( c ) { consoel.log( c ) } );

        default:
            $inputbox.html( "" );

    };

    $( ".selector" ).removeClass( "lightblue" );
    $inputbox.html( "" );

}


$( "#engage" ).click( engage );


function turnShipRight () {
    if ( turningRight ) {
        // toggle off turn
        turningRight = false;
        trek.api(
            'navigation/turn',
            { direction: 'stop' },
            'PUT',
            function () {}
        );
        $turnRight.removeClass( "toggle" );

    } else {
        if ( turningLeft ) {
            turningLeft = false;
            $turnLeft.removeClass( "toggle" );
        }
        turningRight = true;
        trek.api(
            'navigation/turn',
            { direction: 'starboard' },
            'PUT',
            function () {}
        );
        $turnRight.addClass( "toggle" );
    }
}


function turnShipLeft () {

    if ( turningLeft ) {

        // toggle off turn
        turningLeft = false;
        trek.api(
            'navigation/turn',
            { direction : 'stop' },
            'PUT',
            function () {} );
        $turnLeft.removeClass( "toggle" );

    } else {

        if ( turningRight ) {

            turningRight = false;
            $turnRight.removeClass( "toggle" );

        }
        turningLeft = true;
        trek.api(
            'navigation/turn',
            { direction : 'port' },
            'PUT',
            function() {} );
        $turnLeft.addClass( "toggle" );
    }

}


function thrustForward () {

    trek.api(
        "navigation/thrust",
        { direction : "forward" },
        "POST",
        function () { return; } )

}


function thrustBack () {

    trek.api(
        "navigation/thrust",
        { direction : "reverse" },
        "POST",
        function () { return; } )

}


$turnRight.click( turnShipRight );
$turnLeft.click( turnShipLeft );
$thrustUp.click( thrustForward );
$thrustDown.click( thrustDown );


window.onkeydown = function ( d ) {

    console.log( d );

    switch ( menuState ) {

        case MENU_STATES.HELM:
            processHelmKeyCommands( d );
            break;

        case MENU_STATES.WARP:
            processWarpKeyCommands( d );
            break;

    }

}


function processWarpKeyCommands ( d ) {

    switch ( d.keyCode ) {

        // 0
        case 48:
            addCharToInput( "0" );
            break;

        // 1
        case 49:
            addCharToInput( "1" );
            break;

        // 2
        case 50:
            addCharToInput( "2" );
            break;

        // 3
        case 51:
            addCharToInput( "3" );
            break;

        // 4
        case 52:
            addCharToInput( "4" );
            break;

        // 5
        case 53:
            addCharToInput( "5" );
            break;

        // 6
        case 54:
            addCharToInput( "6" );
            break;

        // 7
        case 55:
            addCharToInput( "7" );
            break;

        // 8
        case 56:
            addCharToInput( "8" );
            break;

        // 9
        case 57:
            addCharToInput( "9" );
            break;

        // m
        case 77:
            addCharToInput( "m" );
            break;

        // .
        case 190:
            addCharToInput( "." );
            break;

        // enter
        case 13:
            engage();
            break;

        // e
        case 69:
            engage();
            break;

        // w
        case 87:
            setWarpMenuFunction( "setWarp" );
            break;

        // i
        case 73:
            setWarpMenuFunction( "setImpulse" );
            break;

        // c
        case 67:
            setWarpMenuFunction( "setCourse" );
            break;

    }

}


function processHelmKeyCommands ( d ) {

    switch ( d.keyCode ) {

        // up
        case 38:
            thrustForward();
            break;

        // down
        case 40:
            thrustDown();
            break;

        // left
        case 37:
            turnShipLeft();
            break;

        // right
        case 39:
            turnShipRight();
            break;

    }

}


trek.socket.on( "Navigation", function ( navData ) {

    if ( _.has( navData, "turn_direction" ) ) {
        // best effort turn
        i = setInterval(
            updateNavigationData,
            500);

        // update nav data after turn time
        setTimeout(
            function () {
                clearInterval( i );
                updateNavigationData();
            },
            navData.turn_duration * 1.1 );
    }

});


trek.socket.on( "Turning", function ( navData ) {

    updateNavigationDisplay( navData );

});


function updateNavigationDisplay ( navData ) {

    console.log( navData );

    turnRate = navData.rotation.bearing;
    turnState = navData.bearing.bearing
    var degree = ( 1 - turnState ) * 360 + 90;
    navArrow.setAttribute(
        "transform",
        "rotate(" + degree + ", 119.5, 119.5)");

}

var turnCalcTimeStamp = 0;

function updateOrientation ( tStamp ) {

    if ( turnRate != 0 ) {

        delta = tStamp - turnCalcTimeStamp;
        var b = turnState + turnRate * delta;

        // Normalize the bearing
        if ( b > 1 ) b -= 1;
        if ( b < 0 ) b += 1;

        var degree = ( 1 - b ) * 360 + 90;

        navArrow.setAttribute(
            "transform",
            "rotate(" + degree + ", 119.5, 119.5)" );

        turnCalcTimeStamp = tStamp;

    }

    requestAnimationFrame( updateOrientation );

}


function updateNavigationData() {

    trek.api( 'navigation/status', updateNavigationDisplay );

}

// Setup animation to show orientation movement
requestAnimationFrame( updateOrientation );

// Always select the local system by default
$systemSelections[ 1 ].click();
updateNavigationData();

trek.registerDisplay( "Conn" );
trek.checkBlastDamage();
trek.playBridgeSound();

</script>
<% include footer.html %>
