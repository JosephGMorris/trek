<% include header.html %>
<link rel="stylesheet" href="/static/css/ops_repair_screen.css">

<div id="system_display">
</div>

<script type="text/template" id="system_template">
	<h3>{{name}}</h3>
	<p>Deck {{deck}}, {{section}} Section</p>
    <p>{{integrity}} Integrity</p>
    <p>Repair Requirements:</p>
    <ul>
    {{#repair_requirements}}
        <li class="{{availability}}">{{quantity}} Units of {{material}}</li>
    {{/repair_requirements}}
    </ul>
    <p>Time to complete repair (1 team): {{time_to_repair}} Minutes</p>
    {{#time_to_operability}}
    <p>Time to operability (1 team): {{time_to_operability}}</p>
    {{/time_to_operability}}
    <p>Repair Crews currently assigned: {{repair_crews}}</p>
</script>

<script>
var system_template = $('#system_template').html();
var selected_system = '<%= system_name %>';

function round (n, d) {
    return Math.floor(n * Math.pow(10, d)) / Math.pow(10, d);
};

var consolidated_cargo = {};

function load_systems () {

    trek.api(
        'engineering/status',
        function (data) {

            trek.api(
                'operations/internalScan',
                function (scan) {
                    var section = _.find(
                        data,
                        function (s){
                            return s.name == selected_system
                        }
                    );
                    var repair_crews = _.filter(
                        scan,
                        function (s) {
                            return s.description == "Repair Team" && s.currently_repairing == selected_system
                        }
                    );

                    section.time_to_repair = round(
                        section.time_to_repair / 1000 / 60, 2
                    );

                    if ( section.hasOwnProperty('time_to_operability') ) {
                        section.time_to_operability = round(section.time_to_operability / 1000 / 60, 2)
                    };

                    section['repair_crews'] = repair_crews.length;

                    _.each(
                        section.repair_requirements,
                        function(e, i, l){
                            if (e.quantity > consolidated_cargo[e.material]) {
                                e['availability'] = "red";
                                console.log("unavailable:" + e.material);
                            }
                        }
                    );

                    $('#system_display').html(
                        Mustache.render( system_template, section )
                    );
                }
            );

        }
    );
};

trek.api(
    'operations/cargo',
    function (data) {
        _.each(
            data,
            function (bay, bay_num, cargo_set) {
                _.each(
                    bay,
                    function (v, k, l){
                        if ( consolidated_cargo.hasOwnProperty( k ) ) {
                            consolidated_cargo[k] += v;
                        } else {
                            consolidated_cargo[k] = v;
                        }
                    }
                );
            }
        );
        load_systems();
    }
);

</script>
<% include footer.html %>